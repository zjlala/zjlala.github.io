{"version":3,"file":"WalineComment.js","sources":["../../../src/client/components/WalineComment.ts"],"sourcesContent":["import type { ExactLocaleConfig } from '@vuepress/helper/client'\nimport { LoadingIcon, useLocale, wait } from '@vuepress/helper/client'\nimport { watchImmediate } from '@vueuse/core'\nimport type { WalineProps } from '@waline/client'\nimport { pageviewCount } from '@waline/client/pageview'\nimport type { VNode } from 'vue'\nimport {\n  computed,\n  defineAsyncComponent,\n  defineComponent,\n  h,\n  nextTick,\n  onMounted,\n} from 'vue'\nimport { ClientOnly, useData } from 'vuepress/client'\nimport type {\n  CommentPluginFrontmatter,\n  WalineLocaleData,\n} from '../../shared/index.js'\nimport { useWalineOptions } from '../helpers/index.js'\n\nimport '@waline/client/waline.css'\nimport '../styles/waline.css'\n\ndeclare const WALINE_META: boolean\ndeclare const WALINE_LOCALES: ExactLocaleConfig<WalineLocaleData>\n\nconst walineLocales = WALINE_LOCALES\n\nif (WALINE_META)\n  void import(/* webpackChunkName: \"waline\" */ '@waline/client/waline-meta.css')\n\nexport default defineComponent({\n  name: 'WalineComment',\n\n  props: {\n    /**\n     * The identifier of the comment\n     *\n     * 评论标识符\n     */\n    identifier: {\n      type: String,\n      required: true,\n    },\n  },\n\n  setup(props) {\n    const { frontmatter, lang } = useData<CommentPluginFrontmatter>()\n    const walineOptions = useWalineOptions()\n    const walineLocale = useLocale(walineLocales)\n\n    let abort: (() => void) | null = null\n    const enableWaline = computed(() => Boolean(walineOptions.value.serverURL))\n\n    const enablePageViews = computed(\n      () =>\n        enableWaline.value &&\n        (frontmatter.value.pageview ?? walineOptions.value.pageview ?? true),\n    )\n\n    const walineProps = computed(() => ({\n      lang: lang.value === 'zh-CN' ? 'zh-CN' : 'en',\n      locale: walineLocale.value,\n      dark: \"[data-theme='dark']\",\n      ...walineOptions.value,\n      path: props.identifier,\n    }))\n\n    onMounted(() => {\n      watchImmediate(\n        () => [\n          props.identifier,\n          walineOptions.value.serverURL,\n          walineOptions.value.delay,\n          enablePageViews.value,\n        ],\n        async () => {\n          abort?.()\n          abort = null\n\n          if (enablePageViews.value) {\n            await nextTick()\n            await wait(walineOptions.value.delay ?? 800)\n\n            abort = pageviewCount({\n              serverURL: walineOptions.value.serverURL,\n              path: props.identifier,\n            })\n          }\n        },\n        { flush: 'post' },\n      )\n    })\n\n    return (): VNode | null =>\n      enableWaline.value\n        ? h(\n            'div',\n            { id: 'comment', class: 'waline-wrapper' },\n            h(\n              defineAsyncComponent({\n                loader: async () => {\n                  const { Waline } = await import(\n                    /* webpackChunkName: \"waline\" */ '@waline/client/component'\n                  )\n\n                  return () =>\n                    h(ClientOnly, () =>\n                      h(Waline, walineProps.value as WalineProps),\n                    )\n                },\n                loadingComponent: LoadingIcon,\n              }),\n            ),\n          )\n        : null\n  },\n})\n"],"names":["walineLocales","WalineComment","defineComponent","props","frontmatter","lang","useData","walineOptions","useWalineOptions","walineLocale","useLocale","abort","enableWaline","computed","enablePageViews","walineProps","onMounted","watchImmediate","nextTick","wait","pageviewCount","h","defineAsyncComponent","Waline","ClientOnly","LoadingIcon"],"mappings":"ycA2BA,MAAMA,EAAgB,eAElB,aACG,OAAwC,gCAAgC,EAE/E,IAAAC,EAAeC,EAAgB,CAC7B,KAAM,gBAEN,MAAO,CAML,WAAY,CACV,KAAM,OACN,SAAU,EACZ,CACF,EAEA,MAAMC,EAAO,CACX,KAAM,CAAE,YAAAC,EAAa,KAAAC,CAAK,EAAIC,EAAAA,EACxBC,EAAgBC,EAAAA,EAChBC,EAAeC,EAAUV,CAAa,EAE5C,IAAIW,EAA6B,KACjC,MAAMC,EAAeC,EAAS,IAAM,CAAA,CAAQN,EAAc,MAAM,SAAU,EAEpEO,EAAkBD,EACtB,IACED,EAAa,QACZR,EAAY,MAAM,UAAYG,EAAc,MAAM,UAAY,GACnE,EAEMQ,EAAcF,EAAS,KAAO,CAClC,KAAMR,EAAK,QAAU,QAAU,QAAU,KACzC,OAAQI,EAAa,MACrB,KAAM,sBACN,GAAGF,EAAc,MACjB,KAAMJ,EAAM,UACd,EAAE,EAEF,OAAAa,EAAU,IAAM,CACdC,EACE,IAAM,CACJd,EAAM,WACNI,EAAc,MAAM,UACpBA,EAAc,MAAM,MACpBO,EAAgB,KAClB,EACA,SAAY,CACVH,IAAAA,EACAA,EAAQ,KAEJG,EAAgB,QAClB,MAAMI,IACN,MAAMC,EAAKZ,EAAc,MAAM,OAAS,GAAG,EAE3CI,EAAQS,EAAc,CACpB,UAAWb,EAAc,MAAM,UAC/B,KAAMJ,EAAM,UACd,CAAC,EAEL,EACA,CAAE,MAAO,MAAO,CAClB,CACF,CAAC,EAEM,IACLS,EAAa,MACTS,EACE,MACA,CAAE,GAAI,UAAW,MAAO,gBAAiB,EACzCA,EACEC,EAAqB,CACnB,OAAQ,SAAY,CAClB,KAAM,CAAE,OAAAC,CAAO,EAAI,KAAM,QACU,0BACnC,EAEA,MAAO,IACLF,EAAEG,EAAY,IACZH,EAAEE,EAAQR,EAAY,KAAoB,CAC5C,CACJ,EACA,iBAAkBU,CACpB,CAAC,CACH,CACF,EACA,IACR,CACF,CAAC"}