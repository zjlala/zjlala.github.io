{"version":3,"file":"PDF.js","sources":["../../../src/client/utils/viewPDF.ts","../../../src/client/components/PDF.ts"],"sourcesContent":["/**\n * Fork and edited from https://github.com/pipwerks/PDFObject/blob/master/pdfobject.js\n *\n * The MIT License (MIT)\n * Copyright © 2021 Philip Hutchison\n * https://pipwerks.mit-license.org/\n *\n * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the “Software”), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n */\n\nimport {\n  ensureEndingSlash,\n  entries,\n  isDef,\n  isLinkHttp,\n  isMobile,\n  isSafari,\n  isiPad,\n} from \"@vuepress/helper/client\";\nimport { withBase } from \"vuepress/client\";\n\ndeclare const PDFJS_URL: string | null;\n\nexport interface ViewPDFOptions {\n  /**\n   * Title of pdf\n   */\n  title?: string;\n  hint: string;\n  options: Record<string, string | number | boolean> | undefined;\n  /**\n   * Force using PDFJS\n   */\n  force?: boolean;\n}\n\nconst logError = (msg: string): void => {\n  // eslint-disable-next-line no-console\n  console.error(`[PDF]: ${msg}`);\n};\n\nconst emptyNodeContents = (node: HTMLElement): void => {\n  while (node.firstChild) node.removeChild(node.firstChild);\n};\n\nconst getTargetElement = (\n  targetSelector: string | HTMLElement | null,\n): HTMLElement | null =>\n  targetSelector instanceof HTMLElement\n    ? targetSelector\n    : targetSelector === \"string\"\n      ? document.querySelector(targetSelector)\n      : document.body;\n\n// Create a fragment identifier for using PDF Open parameters when embedding PDF\nconst buildURLFragmentString = (\n  options: Record<string, string | number | boolean>,\n): string => {\n  let url = entries(options)\n    .map(([key, value]) =>\n      key === \"noToolbar\"\n        ? `toolbar=${value ? \"0\" : \"1\"}`\n        : `${encodeURIComponent(key)}=${encodeURIComponent(value)}`,\n    )\n    .join(\"&\");\n\n  /*\n   * The string will be empty if no PDF Params found\n   * Remove last ampersand\n   */\n  if (url) url = `#${url.slice(0, url.length - 1)}`;\n\n  return url;\n};\n\nconst addPDFViewer = (\n  embedType: \"iframe\" | \"embed\" | \"pdfjs\",\n  targetNode: HTMLElement,\n  url: string,\n  options: Record<string, string | number | boolean>,\n  title: string,\n): HTMLElement => {\n  // Ensure target element is empty first\n  emptyNodeContents(targetNode);\n\n  const source = `${\n    embedType === \"pdfjs\"\n      ? `${ensureEndingSlash(\n          // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n          withBase(PDFJS_URL!),\n        )}web/viewer.html?file=${encodeURIComponent(url)}`\n      : url\n  }${buildURLFragmentString(options)}`;\n\n  const elementType =\n    embedType === \"pdfjs\" || embedType === \"iframe\" ? \"iframe\" : \"embed\";\n  const el = document.createElement(elementType);\n\n  el.className = \"pdf-viewer\";\n  // @ts-expect-error: Force override iframe type\n  el.type = \"application/pdf\";\n  el.title = title;\n  el.src = source;\n\n  if (el instanceof HTMLIFrameElement) el.allow = \"fullscreen\";\n\n  targetNode.classList.add(\"pdf-viewer-container\");\n  targetNode.appendChild(el);\n\n  return targetNode.getElementsByTagName(elementType)[0];\n};\n\nexport const viewPDF = (\n  url: string,\n  targetSelector: string | HTMLElement | null,\n  { title, hint, options = {}, force }: ViewPDFOptions,\n): HTMLElement | null => {\n  // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition\n  if (typeof window === \"undefined\" || !window?.navigator?.userAgent)\n    return null;\n\n  const { navigator } = window;\n  const { userAgent } = navigator;\n\n  // Time to jump through hoops -- browser vendors do not make it easy to detect PDF support.\n\n  /*\n   * There is a coincidental correlation between implementation of window.promises and native PDF support in desktop browsers\n   * We use this to assume if the browser supports promises it supports embedded PDFs\n   * Is this fragile? Sort of. But browser vendors removed mimetype detection, so we're left to improvise\n   */\n  const isModernBrowser = isDef(window.Promise);\n\n  // Quick test for mobile devices.\n  const isMobileDevice = isiPad(userAgent) || isMobile(userAgent);\n\n  // Safari desktop requires special handling\n  const isSafariDesktop = !isMobileDevice && isSafari(userAgent);\n\n  // Firefox started shipping PDF.js in Firefox 19. If this is Firefox 19 or greater, assume PDF.js is available\n  const isFirefoxWithPDFJS =\n    !isMobileDevice &&\n    /firefox/iu.test(userAgent) &&\n    userAgent.split(\"rv:\").length > 1\n      ? parseInt(userAgent.split(\"rv:\")[1].split(\".\")[0], 10) > 18\n      : false;\n\n  // Determines whether PDF support is available\n  const supportsPDFs =\n    // As of Sept 2020 no mobile browsers properly support PDF embeds\n    !isMobileDevice &&\n    // We're moving into the age of MIME-less browsers. They mostly all support PDF rendering without plugins.\n    (isModernBrowser ||\n      // Modern versions of Firefox come bundled with PDFJS\n      isFirefoxWithPDFJS);\n\n  const targetNode = getTargetElement(targetSelector);\n\n  if (!targetNode) {\n    logError(\"Target element cannot be determined\");\n\n    return null;\n  }\n\n  const pdfLink = isLinkHttp(url)\n    ? url\n    : __VUEPRESS_DEV__\n      ? null\n      : `${window.origin}${url}`;\n  const pdfTitle = title ?? /\\/([^/]+).pdf/.exec(url)?.[1] ?? \"PDF Viewer\";\n\n  if (force) {\n    if (!pdfLink) {\n      logError(\"PDF link is not accessible.\");\n\n      return null;\n    }\n\n    if (!PDFJS_URL) {\n      targetNode.innerHTML = hint.replace(/\\[url\\]/g, pdfLink);\n      logError(\"PDFJS URL is not defined\");\n\n      return null;\n    }\n\n    return addPDFViewer(\"pdfjs\", targetNode, url, options, pdfTitle);\n  }\n\n  if (supportsPDFs || !isMobileDevice) {\n    /*\n     * There is an edge case where Safari does not respect 302 redirect requests for PDF files when using <embed> element.\n     * Redirect appears to work fine when using <iframe> instead of <embed> (Addresses issue #210)\n     * Forcing Safari desktop to use iframe due to freezing bug in macOS 11 (Big Sur)\n     */\n    const embedType = isSafariDesktop ? \"iframe\" : \"embed\";\n\n    return addPDFViewer(embedType, targetNode, url, options, pdfTitle);\n  }\n\n  if (PDFJS_URL && pdfLink)\n    return addPDFViewer(\"pdfjs\", targetNode, url, options, pdfTitle);\n\n  targetNode.innerHTML = hint.replace(/\\[url\\]/g, url);\n\n  logError(\"This browser does not support embedded PDFs\");\n\n  return null;\n};\n","import type { ExactLocaleConfig } from \"@vuepress/helper/client\";\nimport { useLocaleConfig } from \"@vuepress/helper/client\";\nimport { useScrollLock } from \"@vueuse/core\";\nimport type { VNode } from \"vue\";\nimport {\n  defineComponent,\n  h,\n  onMounted,\n  onUnmounted,\n  ref,\n  shallowRef,\n  watch,\n} from \"vue\";\nimport {\n  CancelFullScreenIcon,\n  EnterFullScreenIcon,\n} from \"vuepress-shared/client\";\n\nimport type { PDFLocaleData } from \"../../shared/locales.js\";\nimport { useSize } from \"../composables/index.js\";\nimport { getLink, viewPDF } from \"../utils/index.js\";\n\nimport \"../styles/pdf.scss\";\n\ndeclare const PDF_LOCALES: ExactLocaleConfig<PDFLocaleData>;\n\nexport default defineComponent({\n  name: \"PDF\",\n\n  props: {\n    /**\n     * PDF link, should be absolute url\n     *\n     * PDF 文件链接，应为完整链接\n     */\n    url: {\n      type: String,\n      required: true,\n    },\n\n    /**\n     * PDF title\n     *\n     * PDF 标题\n     */\n    title: String,\n\n    /**\n     * Component width\n     *\n     * 组件宽度\n     */\n    width: {\n      type: [String, Number],\n      default: \"100%\",\n    },\n\n    /**\n     * Component height\n     *\n     * 组件高度\n     */\n    height: [String, Number],\n\n    /**\n     * Component width / height ratio\n     *\n     * 组件长宽比\n     */\n    ratio: {\n      type: [String, Number],\n      default: 16 / 9,\n    },\n\n    /**\n     * PDF initial page number\n     *\n     * PDF 初始页码\n     *\n     * @description Chrome only\n     */\n    page: {\n      type: [String, Number],\n      default: 1,\n    },\n\n    /**\n     * Whether show toolbar\n     *\n     * 是否显示工具栏\n     *\n     * @description Chrome only\n     */\n    noToolbar: Boolean,\n\n    /**\n     * Whether disable fullscreen button\n     *\n     * 是否禁用全屏按钮\n     */\n    noFullscreen: Boolean,\n\n    /**\n     * Initial zoom level (in percent)\n     *\n     * 初始缩放比率 (百分比)\n     */\n    zoom: [String, Number],\n\n    /**\n     * Whether use pdfjs viewer by force\n     *\n     * 是否强制使用 pdfjs 阅读器\n     */\n    viewer: Boolean,\n  },\n\n  setup(props) {\n    const { el, width, height, resize } = useSize<HTMLDivElement>(props);\n    const locales = useLocaleConfig(PDF_LOCALES);\n\n    const body = shallowRef<HTMLElement>();\n    const viewer = shallowRef<HTMLElement>();\n    const isLocked = useScrollLock(body);\n\n    const isFullscreen = ref(false);\n\n    watch(isFullscreen, (value) => {\n      isLocked.value = value;\n    });\n\n    onMounted(() => {\n      body.value = document.body;\n\n      // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n      viewPDF(getLink(props.url), viewer.value!, {\n        title: props.title,\n        hint: locales.value.hint,\n        options: {\n          page: props.page,\n          noToolbar: props.noToolbar,\n          ...(props.zoom && props.zoom.toString() !== \"100\"\n            ? { zoom: props.zoom }\n            : {}),\n        },\n        force: props.viewer,\n      });\n      resize();\n    });\n\n    onUnmounted(() => {\n      isLocked.value = false;\n    });\n\n    return (): VNode =>\n      h(\n        \"div\",\n        {\n          class: [\"pdf-viewer-wrapper\", { fullscreen: isFullscreen.value }],\n          ref: el,\n          style: isFullscreen.value\n            ? {}\n            : {\n                width: width.value,\n                height: height.value,\n              },\n        },\n        [\n          h(\"div\", { ref: viewer }),\n          props.noFullscreen\n            ? null\n            : h(\n                \"button\",\n                {\n                  class: \"pdf-fullscreen-button\",\n                  onClick: () => {\n                    isFullscreen.value = !isFullscreen.value;\n                  },\n                },\n                h(\n                  isFullscreen.value\n                    ? CancelFullScreenIcon\n                    : EnterFullScreenIcon,\n                  { class: \"pdf-fullscreen-icon\" },\n                ),\n              ),\n        ],\n      );\n  },\n});\n"],"names":["logError","msg","emptyNodeContents","node","getTargetElement","targetSelector","buildURLFragmentString","options","url","entries","key","value","addPDFViewer","embedType","targetNode","title","source","ensureEndingSlash","withBase","elementType","el","viewPDF","hint","force","navigator","userAgent","isModernBrowser","isDef","isMobileDevice","isiPad","isMobile","isSafariDesktop","isSafari","isFirefoxWithPDFJS","supportsPDFs","pdfLink","isLinkHttp","pdfTitle","PDF","defineComponent","props","width","height","resize","useSize","locales","useLocaleConfig","body","shallowRef","viewer","isLocked","useScrollLock","isFullscreen","ref","watch","onMounted","getLink","onUnmounted","h","CancelFullScreenIcon","EnterFullScreenIcon"],"mappings":"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"}