{"version":3,"file":"MarkMap.js","sources":["../../../src/client/components/MarkMap.ts"],"sourcesContent":["import { LoadingIcon, decodeData } from '@vuepress/helper/client'\nimport { useDebounceFn, useEventListener } from '@vueuse/core'\nimport type { Markmap } from 'markmap-view'\nimport type { VNode } from 'vue'\nimport {\n  defineComponent,\n  h,\n  nextTick,\n  onMounted,\n  onUnmounted,\n  ref,\n  shallowRef,\n  toRefs,\n  watch,\n} from 'vue'\nimport { onContentUpdated } from 'vuepress/client'\n\nimport '../styles/markmap.css'\n\nexport default defineComponent({\n  name: 'MarkMap',\n\n  props: {\n    /**\n     * Markmap content\n     *\n     * Markmap\n     */\n    content: {\n      type: String,\n      required: true,\n    },\n  },\n\n  setup(props) {\n    const { content } = toRefs(props)\n    const markmapWrapper = shallowRef<HTMLElement>()\n    const markmapSVG = shallowRef<SVGElement>()\n\n    const loaded = ref(false)\n\n    let markmap: Markmap | null = null\n\n    useEventListener(\n      'resize',\n      useDebounceFn(() => {\n        void markmap?.fit()\n      }, 100),\n    )\n\n    const destroyMarkmap = (): void => {\n      markmap?.destroy()\n      markmap = null\n    }\n\n    const renderMarkmap = async (): Promise<void> => {\n      if (__VUEPRESS_SSR__) return\n\n      const [{ Transformer }, markmapView, { Toolbar }] = await Promise.all([\n        import(/* webpackChunkName: \"markmap\" */ 'markmap-lib'),\n        import(/* webpackChunkName: \"markmap\" */ 'markmap-view'),\n        import(/* webpackChunkName: \"markmap\" */ 'markmap-toolbar'),\n      ])\n\n      const { Markmap, deriveOptions, loadJS, loadCSS } = markmapView\n\n      const transformer = new Transformer()\n      const { frontmatter, features, root } = transformer.transform(\n        decodeData(props.content),\n      )\n      const { styles, scripts } = transformer.getUsedAssets(features)\n\n      await Promise.all([\n        // Load scripts\n        scripts\n          ? loadJS(scripts, {\n              // For plugins to access the `markmap-view` module\n              getMarkmap: () => markmapView,\n            })\n          : Promise.resolve(),\n        // Load styles\n        styles ? loadCSS(styles) : Promise.resolve(),\n      ])\n\n      markmap = Markmap.create(\n        markmapSVG.value!,\n        deriveOptions({\n          maxWidth: 240,\n          ...frontmatter?.markmap,\n        }),\n      )\n\n      const { el } = Toolbar.create(markmap)\n\n      await markmap.setData(root)\n      await markmap.fit()\n\n      el.style.position = 'absolute'\n      el.style.bottom = '0.5rem'\n      el.style.right = '0.5rem'\n\n      markmapWrapper.value!.append(el)\n    }\n\n    onContentUpdated(async (reason) => {\n      if (reason === 'mounted') {\n        await renderMarkmap()\n        loaded.value = true\n      }\n    })\n\n    onMounted(() => {\n      if (!__VUEPRESS_DEV__) return\n\n      watch(\n        content,\n        async () => {\n          destroyMarkmap()\n          await nextTick()\n          await renderMarkmap()\n        },\n        { flush: 'post' },\n      )\n    })\n\n    onUnmounted(destroyMarkmap)\n\n    return (): VNode =>\n      h('div', { class: 'markmap-wrapper', ref: markmapWrapper }, [\n        h('svg', {\n          ref: markmapSVG,\n          class: 'markmap-svg',\n        }),\n        loaded.value\n          ? null\n          : h(LoadingIcon, { class: 'markmap-loading', height: 360 }),\n      ])\n  },\n})\n"],"names":["MarkMap","defineComponent","props","content","toRefs","markmapWrapper","shallowRef","markmapSVG","loaded","ref","markmap","useEventListener","useDebounceFn","destroyMarkmap","renderMarkmap","Transformer","markmapView","Toolbar","Markmap","deriveOptions","loadJS","loadCSS","transformer","frontmatter","features","root","decodeData","styles","scripts","el","onContentUpdated","reason","onMounted","watch","nextTick","onUnmounted","h","LoadingIcon"],"mappings":"qWAmBA,IAAAA,EAAeC,EAAgB,CAC7B,KAAM,UAEN,MAAO,CAML,QAAS,CACP,KAAM,OACN,SAAU,EACZ,CACF,EAEA,MAAMC,EAAO,CACX,KAAM,CAAE,QAAAC,CAAQ,EAAIC,EAAOF,CAAK,EAC1BG,EAAiBC,EAAAA,EACjBC,EAAaD,EAAAA,EAEbE,EAASC,EAAI,EAAK,EAExB,IAAIC,EAA0B,KAE9BC,EACE,SACAC,EAAc,IAAM,CACbF,GAAS,IAAA,CAChB,EAAG,GAAG,CACR,EAEA,MAAMG,EAAiB,IAAY,CACjCH,GAAS,QAAA,EACTA,EAAU,IACZ,EAEMI,EAAgB,SAA2B,CAC/C,GAAI,iBAAkB,OAEtB,KAAM,CAAC,CAAE,YAAAC,CAAY,EAAGC,EAAa,CAAE,QAAAC,CAAQ,CAAC,EAAI,MAAM,QAAQ,IAAI,CACpE,OAAyC,aAAa,EACtD,OAAyC,cAAc,EACvD,OAAyC,iBAAiB,CAC5D,CAAC,EAEK,CAAE,QAAAC,EAAS,cAAAC,EAAe,OAAAC,EAAQ,QAAAC,CAAQ,EAAIL,EAE9CM,EAAc,IAAIP,EAClB,CAAE,YAAAQ,EAAa,SAAAC,EAAU,KAAAC,CAAK,EAAIH,EAAY,UAClDI,EAAWxB,EAAM,OAAO,CAC1B,EACM,CAAE,OAAAyB,EAAQ,QAAAC,CAAQ,EAAIN,EAAY,cAAcE,CAAQ,EAE9D,MAAM,QAAQ,IAAI,CAEhBI,EACIR,EAAOQ,EAAS,CAEd,WAAY,IAAMZ,CACpB,CAAC,EACD,QAAQ,QAAA,EAEZW,EAASN,EAAQM,CAAM,EAAI,QAAQ,QAAA,CACrC,CAAC,EAEDjB,EAAUQ,EAAQ,OAChBX,EAAW,MACXY,EAAc,CACZ,SAAU,IACV,GAAGI,GAAa,OAClB,CAAC,CACH,EAEA,KAAM,CAAE,GAAAM,CAAG,EAAIZ,EAAQ,OAAOP,CAAO,EAErC,MAAMA,EAAQ,QAAQe,CAAI,EAC1B,MAAMf,EAAQ,IAAA,EAEdmB,EAAG,MAAM,SAAW,WACpBA,EAAG,MAAM,OAAS,SAClBA,EAAG,MAAM,MAAQ,SAEjBxB,EAAe,MAAO,OAAOwB,CAAE,CACjC,EAEA,OAAAC,EAAiB,MAAOC,GAAW,CAC7BA,IAAW,YACb,MAAMjB,IACNN,EAAO,MAAQ,GAEnB,CAAC,EAEDwB,EAAU,IAAM,CACT,kBAELC,EACE9B,EACA,SAAY,CACVU,IACA,MAAMqB,EAAAA,EACN,MAAMpB,EAAAA,CACR,EACA,CAAE,MAAO,MAAO,CAClB,CACF,CAAC,EAEDqB,EAAYtB,CAAc,EAEnB,IACLuB,EAAE,MAAO,CAAE,MAAO,kBAAmB,IAAK/B,CAAe,EAAG,CAC1D+B,EAAE,MAAO,CACP,IAAK7B,EACL,MAAO,aACT,CAAC,EACDC,EAAO,MACH,KACA4B,EAAEC,EAAa,CAAE,MAAO,kBAAmB,OAAQ,GAAI,CAAC,CAC9D,CAAC,CACL,CACF,CAAC"}